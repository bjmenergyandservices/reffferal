<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post Your Listing - REFERALLS</title>
<style>
  body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #f4f6f8; }
   header { background: #008000; color: white; text-align: center; padding: 15px; } 
   /* Back button styling */ 
   .nav-btn { display: block; width: fit-content; margin: 20px auto 0 auto; background: #ffa500; color: white; padding: 10px 18px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; text-decoration: none; } 
   .nav-btn:hover { background: #e69500; } 
   .upload-container { max-width: 500px; background: white; margin: 30px auto; padding: 25px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); } 
   h2 { text-align: center; color: #333; } 
   form { display: flex; flex-direction: column; gap: 15px; } 
   input, select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; } 
   button { background: #008000; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; } 
   button:hover { background: #006400; } 
   .success, .error { text-align: center; padding: 10px; border-radius: 6px; } 
   .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
     </style> 
     <script>
     Check if the user is logged in const user = 
     JSON.parse(localStorage.getItem("user")); 
     if (!user) { alert("You must log in first to post a listing.");
      window.location.href = "login.html"; }
      </script>
</head>
<body>

<header>
  <h1>Post Your Listing on REFERALLS</h1>
</header>

<a href="index.html" class="nav-btn">← Back to Dashboard</a>

<div class="upload-container">
  <h2>Upload Your Car or House</h2>

  <form id="uploadForm" enctype="multipart/form-data">
    <select name="category" required>
      <option value="">Select Category</option>
      <option value="House">House</option>
      <option value="Car">Car</option>
    </select>

    <input type="text" name="title" placeholder="Enter title" required>
    <input type="number" name="price" placeholder="Enter price (₦)" required>
    <textarea name="description" placeholder="Describe your listing..." rows="4" required></textarea>
    <input type="file" name="image" accept="image/*" required>
    <button type="submit">Upload Listing</button>
  </form>

  <div id="message"></div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { ref, uploadBytes, getDownloadURL, getStorage } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

await addDoc(collection(db, "listings"), {
  uid: user.uid,
  sellerName: user.displayName || user.email,
  sellerEmail: user.email,
  verifiedSeller: true,
  category,
  title,
  price: Number(price),
  description,
  imageURL,
  createdAt: serverTimestamp()
});


const form = document.getElementById("uploadForm");
const message = document.getElementById("message");
const storage = getStorage();

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const category = form.category.value;
  const title = form.title.value.trim();
  const price = form.price.value.trim();
  const description = form.description.value.trim();
  const file = form.image.files[0];
  const user = auth.currentUser;

  if (!category || !title || !price || !description || !file) {
    message.innerHTML = '<div class="error">⚠️ Please fill in all fields.</div>';
    return;
  }

  try {
    // 1️⃣ Upload image to Firebase Storage
    const storageRef = ref(storage, `listings/${user.uid}/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const imageURL = await getDownloadURL(storageRef);

    // 2️⃣ Save listing info to Firestore
    await addDoc(collection(db, "listings"), {
      uid: user.uid,
      category,
      title,
      price: Number(price),
      description,
      imageURL,
      createdAt: serverTimestamp()
    });

    message.innerHTML = '<div class="success">✅ Listing uploaded successfully!</div>';
    form.reset();

  } catch (err) {
    console.error(err);
    message.innerHTML = `<div class="error">⚠️ Error uploading listing: ${err.message}</div>`;
  }
});

console.log("Firebase connected on upload.html");
</script>

</body>
</html>
